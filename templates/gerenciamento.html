{% extends "base.html" %}

{% block title %}Gerenciamento de Inventário - LTIP{% endblock %}

{% block content %}
<div class="container mx-auto p-6 font-inter">
    <h1 class="text-4xl font-extrabold text-primary mb-4 text-center">Painel de Gerenciamento do Laboratório</h1>
    <p class="text-center text-ltip-text/70 mb-8">Administre máquinas, equipamentos gerais e informações de contato.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mb-6 space-y-3">
        {% for category, message in messages %}
            {% if category == 'success' %}
            <div class="p-4 bg-ltip-dark-accent border border-ltip-success text-ltip-success rounded-lg shadow-md font-medium" role="alert">
                {{ message }}
            </div>
            {% elif category == 'error' %}
            <div class="p-4 bg-ltip-dark-accent border border-ltip-error text-ltip-error rounded-lg shadow-md font-medium" role="alert">
                {{ message }}
            </div>
            {% else %}
            <div class="p-4 bg-ltip-dark-accent border border-primary text-primary rounded-lg shadow-md font-medium" role="alert">
                {{ message }}
            </div>
            {% endif %}
        {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <div class="bg-ltip-dark-accent p-8 rounded-2xl shadow-2xl border border-primary">
        <div class="border-b border-ltip-dark-accent mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-info-btn" onclick="changeTab('info')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-ltip-text/70 hover:text-primary transition duration-150 hover:border-primary" aria-current="page">
                    Informações de Contato
                </button>
                <button id="tab-cadastro-btn" onclick="changeTab('cadastro')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-ltip-text/70 hover:text-primary transition duration-150 hover:border-primary">
                    Cadastro de Inventário
                </button>
            </nav>
        </div>

        <div id="info" class="tab-content space-y-6">
            <h2 class="text-2xl font-bold text-primary mb-4">Atualizar Informações de Contato</h2>
            <form method="POST" action="{{ url_for('gerenciamento') }}?tab=info" class="space-y-6">
                
                <h3 class="text-xl font-semibold text-ltip-text border-b border-ltip-dark-accent pb-2 mt-6">Dados do Coordenador</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="coordenador_name" class="block text-sm font-medium text-ltip-text mb-1">Nome do Coordenador</label>
                        <input type="text" name="coordenador_name" id="coordenador_name" 
                               value="{{ lab_info.coordenador_name if lab_info else '' }}" 
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>
                    <div>
                        <label for="coordenador_email" class="block text-sm font-medium text-ltip-text mb-1">Email do Coordenador</label>
                        <input type="email" name="coordenador_email" id="coordenador_email" 
                               value="{{ lab_info.coordenador_email if lab_info else '' }}" 
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-ltip-text border-b border-ltip-dark-accent pb-2 mt-6">Dados do Bolsista</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="bolsista_name" class="block text-sm font-medium text-ltip-text mb-1">Nome do Bolsista</label>
                        <input type="text" name="bolsista_name" id="bolsista_name" 
                               value="{{ lab_info.bolsista_name if lab_info else '' }}" 
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>
                    <div>
                        <label for="bolsista_email" class="block text-sm font-medium text-ltip-text mb-1">Email do Bolsista</label>
                        <input type="email" name="bolsista_email" id="bolsista_email" 
                               value="{{ lab_info.bolsista_email if lab_info else '' }}" 
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>
                </div>

                <button type="submit" class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-bold text-ltip-text bg-primary hover:bg-ltip-dark-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    Atualizar Informações
                </button>
            </form>
        </div>

        <div id="cadastro" class="tab-content hidden space-y-6">
            <h2 class="text-2xl font-bold text-primary mb-4">Cadastro de Máquinas e Equipamentos</h2>

            <div class="flex space-x-4 mb-6">
                <button id="btn-maquina" onclick="toggleForm('maquina')" class="form-toggle-btn inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-ltip-text bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150">
                    Cadastrar Máquina
                </button>
                <button id="btn-equipamento" onclick="toggleForm('equipamento')" class="form-toggle-btn inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-ltip-text bg-ltip-dark-accent hover:bg-primary/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ltip-success transition duration-150">
                    Cadastrar Equipamento Geral
                </button>
            </div>

            <div id="form-maquina" class="hidden">
                <form method="POST" action="{{ url_for('gerenciamento') }}?tab=cadastro" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="form_type" value="maquina">
                    <input type="hidden" name="activeForm" value="maquina">
                    <h3 class="text-xl font-semibold text-primary border-b border-ltip-dark-accent pb-2">Detalhes da Máquina</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="m_tombo" class="block text-sm font-medium text-ltip-text mb-1">Tombo / N° Patrimônio</label>
                            <input type="text" name="tombo" id="m_tombo" required 
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary" 
                                   placeholder="Ex: 123456-7">
                        </div>
                        <div>
                            <label for="m_nome" class="block text-sm font-medium text-ltip-text mb-1">Nome/Descrição</label>
                            <input type="text" name="nome" id="m_nome" required 
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                                   placeholder="Ex: Computador Dell OptiPlex">
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-primary border-b border-ltip-dark-accent pb-2">Configurações</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="m_processador" class="block text-sm font-medium text-ltip-text mb-1">Processador</label>
                            <input type="text" name="processador" id="m_processador" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Ex: Core i5 10ª Gen">
                        </div>
                        <div>
                            <label for="m_ram" class="block text-sm font-medium text-ltip-text mb-1">Memória RAM</label>
                            <input type="text" name="memoria_ram" id="m_ram" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Ex: 16 GB DDR4">
                        </div>
                        <div>
                            <label for="m_so" class="block text-sm font-medium text-ltip-text mb-1">Sistema Operacional</label>
                            <input type="text" name="sistema_operacional" id="m_so" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Ex: Windows 10 Pro">
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-primary border-b border-ltip-dark-accent pb-2">Outras Informações</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="m_localizacao" class="block text-sm font-medium text-ltip-text mb-1">Localização</label>
                            <input type="text" name="localizacao" id="m_localizacao" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Ex: Sala 301 - Mesa 1">
                        </div>
                        <div>
                            <label for="m_image" class="block text-sm font-medium text-ltip-text mb-1">Imagem (Opcional)</label>
                            <input type="file" name="image" id="m_image" accept="image/*" class="block w-full text-sm text-ltip-text/80 bg-ltip-dark-accent file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-ltip-text hover:file:bg-ltip-dark-accent hover:file:text-primary mt-1 transition duration-150">
                        </div>
                    </div>

                    <div>
                        <label for="m_observacoes" class="block text-sm font-medium text-ltip-text mb-1">Observações</label>
                        <textarea name="observacoes" id="m_observacoes" rows="3" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Detalhes adicionais, licenças de software, etc."></textarea>
                    </div>
                    
                    <button type="submit" class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-bold text-ltip-text bg-primary hover:bg-ltip-dark-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                        Cadastrar Máquina
                    </button>
                </form>
            </div>

            <div id="form-equipamento" class="hidden">
                <form method="POST" action="{{ url_for('gerenciamento') }}?tab=cadastro" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="form_type" value="equipamento">
                    <input type="hidden" name="activeForm" value="equipamento">
                    <h3 class="text-xl font-semibold text-ltip-success border-b border-ltip-dark-accent pb-2">Detalhes do Equipamento Geral</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="e_tombo" class="block text-sm font-medium text-ltip-text mb-1">Tombo / N° Patrimônio</label>
                            <input type="text" name="tombo" id="e_tombo" required 
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-ltip-success focus:ring-ltip-success" 
                                   placeholder="Ex: 98765-4">
                        </div>
                        <div>
                            <label for="e_nome" class="block text-sm font-medium text-ltip-text mb-1">Nome/Descrição</label>
                            <input type="text" name="nome" id="e_nome" required 
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-ltip-success focus:ring-ltip-success"
                                   placeholder="Ex: Projetor Epson">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="e_localizacao" class="block text-sm font-medium text-ltip-text mb-1">Localização</label>
                            <input type="text" name="localizacao" id="e_localizacao" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-ltip-success focus:ring-ltip-success" placeholder="Ex: Almoxarifado">
                        </div>
                        <div>
                            <label for="e_status" class="block text-sm font-medium text-ltip-text mb-1">Status</label>
                            <select name="status" id="e_status" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-ltip-success focus:ring-ltip-success">
                                <option value="Disponível">Disponível</option>
                                <option value="Em uso">Em uso</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Descartado">Descartado</option>
                            </select>
                        </div>
                        <div>
                            <label for="e_image" class="block text-sm font-medium text-ltip-text mb-1">Imagem (Opcional)</label>
                            <input type="file" name="image" id="e_image" accept="image/*" class="block w-full text-sm text-ltip-text/80 bg-ltip-dark-accent file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-ltip-success file:text-ltip-text hover:file:bg-ltip-dark-accent hover:file:text-ltip-success mt-1 transition duration-150">
                        </div>
                    </div>

                    <div>
                        <label for="e_observacoes" class="block text-sm font-medium text-ltip-text mb-1">Observações</label>
                        <textarea name="observacoes" id="e_observacoes" rows="3" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-ltip-success focus:ring-ltip-success" placeholder="Detalhes, estado de conservação, previsão de manutenção."></textarea>
                    </div>

                    <button type="submit" class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-bold text-ltip-text bg-ltip-success hover:bg-ltip-success/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ltip-success transition duration-200">
                        Cadastrar Equipamento
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function changeTab(tabName) {
        // ... (Mesma lógica de switchTab)
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(tabName).classList.remove('hidden');

        // Reset classes for visual tab indicator
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-primary', 'text-primary');
            btn.classList.add('border-transparent', 'text-ltip-text/70');
        });

        // Apply active classes
        const activeBtn = document.getElementById(`tab-${tabName}-btn`);
        if (activeBtn) {
            activeBtn.classList.add('border-primary', 'text-primary');
            activeBtn.classList.remove('border-transparent', 'text-ltip-text/70');
        }
        
        // Se a aba for 'cadastro', garantir que um formulário esteja ativo
        if (tabName === 'cadastro') {
            // Tenta obter o form ativo do localStorage ou usa 'maquina' como padrão
            const activeForm = localStorage.getItem('activeForm') || 'maquina';
            toggleForm(activeForm); 
        } else {
             // Limpa o localStorage para a próxima vez
             localStorage.removeItem('activeForm');
        }
        
        // Atualiza a URL sem recarregar a página
        history.replaceState(null, '', `{{ url_for('gerenciamento') }}?tab=${tabName}`);
    }
    
    // Função para alternar entre os formulários de máquina e equipamento
    function toggleForm(formType) {
        const formMaquina = document.getElementById('form-maquina');
        const formEquipamento = document.getElementById('form-equipamento');
        const btnMaquina = document.getElementById('btn-maquina');
        const btnEquipamento = document.getElementById('btn-equipamento');
        
        // Reset all buttons to inactive gray/default
        document.querySelectorAll('.form-toggle-btn').forEach(btn => {
            // Remove active classes
            btn.classList.remove('bg-primary', 'hover:bg-primary/90', 'bg-ltip-success', 'hover:bg-ltip-success/90');
            // Add inactive classes (using ltip-dark-accent for better dark mode compatibility)
            btn.classList.add('bg-ltip-dark-accent', 'hover:bg-primary/50');
        });
        
        if (formType === 'maquina') {
            formMaquina.classList.remove('hidden');
            formEquipamento.classList.add('hidden');
            // Aplica cor primária (Azul Claro) ao botão ativo
            btnMaquina.classList.add('bg-primary', 'hover:bg-primary/90');
            btnMaquina.classList.remove('bg-ltip-dark-accent', 'hover:bg-primary/50');
            localStorage.setItem('activeForm', 'maquina');
        } else if (formType === 'equipamento') {
            formMaquina.classList.add('hidden');
            formEquipamento.classList.remove('hidden');
            // Aplica cor de Sucesso (Verde) ao botão ativo
            btnEquipamento.classList.add('bg-ltip-success', 'hover:bg-ltip-success/90');
            btnEquipamento.classList.remove('bg-ltip-dark-accent', 'hover:bg-primary/50');
            localStorage.setItem('activeForm', 'equipamento');
        }
    }
    
    // Inicializa a aba correta ao carregar a página (passado via Jinja)
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab') || "info"; 
        
        changeTab(activeTab);

        // Se a aba de cadastro estiver ativa, garante que o formulário correto seja exibido
        if (activeTab === 'cadastro') {
            const activeFormFromUrl = urlParams.get('active_form') || localStorage.getItem('activeForm') || 'maquina';
            toggleForm(activeFormFromUrl);
        }
    });
</script>
{% endblock %}
